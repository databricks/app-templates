bundle:
  name: agent-langchain-ts

variables:
  serving_endpoint_name:
    description: "The name of the Databricks model serving endpoint to use"
    default: "databricks-claude-sonnet-4-5"

  resource_name_suffix:
    description: "Suffix to add to resource names for uniqueness"
    default: "dev"

  mlflow_experiment_id:
    description: "MLflow experiment ID for traces (optional - will be created if not provided)"
    default: ""

include:
  - resources/*.yml

resources:
  apps:
    agent_langchain_ts:
      name: agent-lc-ts-${var.resource_name_suffix}
      description: "TypeScript LangChain agent with MLflow tracing and MCP tools"
      source_code_path: ./
      resources:
        # ============================================
        # Required: Model Serving Endpoint
        # ============================================
        - name: serving-endpoint
          serving_endpoint:
            name: ${var.serving_endpoint_name}
            permission: CAN_QUERY

        # ============================================
        # Optional: MLflow Experiment
        # ============================================
        # Uncomment and set mlflow_experiment_id variable to link traces
        # - name: mlflow-experiment
        #   experiment:
        #     experiment_id: ${var.mlflow_experiment_id}
        #     permission: CAN_MANAGE

        # ============================================
        # MCP Tool Permissions
        # ============================================

        # Databricks SQL MCP - Schema Access
        # Required when ENABLE_SQL_MCP=true
        # Grants access to query tables in this schema
        - name: catalog-schema
          schema:
            schema_name: main.default
            permission: USE_SCHEMA

        # Databricks SQL MCP - Table Access
        # Required when ENABLE_SQL_MCP=true
        # Grant SELECT on specific tables the agent should query
        - name: customers-table
          table:
            table_name: main.default.customers
            permission: SELECT

        - name: orders-table
          table:
            table_name: main.default.orders
            permission: SELECT

        # Unity Catalog Function
        # Required when UC_FUNCTION_CATALOG/SCHEMA/NAME are set
        # Allows agent to execute this UC function as a tool
        - name: uc-function
          registered_model:
            model_name: main.default.get_customer_info
            permission: EXECUTE

        # Vector Search Index
        # Required when VECTOR_SEARCH_CATALOG/SCHEMA/INDEX are set
        # Allows agent to query vector search index for RAG
        - name: vector-search-index
          quality_monitor:
            table_name: main.default.product_docs_index
            permission: CAN_VIEW

        # Genie Space
        # Required when GENIE_SPACE_ID is set
        # Allows agent to query Genie space with natural language
        - name: genie-space
          quality_monitor:
            table_name: genie.space.01234567-89ab-cdef-0123-456789abcdef
            permission: CAN_EDIT

        # ============================================
        # Example Configurations for Different Use Cases
        # ============================================

        # Data Analyst Agent
        # Uncomment for: SQL queries + business intelligence
        # - name: sales-schema
        #   schema:
        #     schema_name: main.sales
        #     permission: USE_SCHEMA
        # - name: transactions-table
        #   table:
        #     table_name: main.sales.transactions
        #     permission: SELECT
        # - name: analytics-genie
        #   quality_monitor:
        #     table_name: genie.space.your-analytics-space-id
        #     permission: CAN_EDIT

        # Customer Support Agent
        # Uncomment for: Customer lookup + support docs search
        # - name: support-function
        #   registered_model:
        #     model_name: main.support.get_customer_history
        #     permission: EXECUTE
        # - name: support-docs-vector
        #   quality_monitor:
        #     table_name: main.support.support_docs_index
        #     permission: CAN_VIEW

        # RAG Documentation Agent
        # Uncomment for: Semantic search over documentation
        # - name: docs-vector-index
        #   quality_monitor:
        #     table_name: main.docs.product_documentation_index
        #     permission: CAN_VIEW

targets:
  dev:
    mode: development
    default: true
    workspace:
      profile: dogfood

  prod:
    mode: production
    workspace:
      profile: dogfood

    # Production-specific configuration
    variables:
      resource_name_suffix:
        default: "prod"

# ============================================
# Notes on Resource Permissions
# ============================================

# Schema Permission (USE_SCHEMA):
# - Grants access to list and query tables in the schema
# - Required for ENABLE_SQL_MCP=true
# - Syntax: main.{schema_name}

# Table Permission (SELECT):
# - Grants read access to specific table
# - More granular than schema-level permissions
# - Syntax: {catalog}.{schema}.{table}

# Registered Model Permission (EXECUTE):
# - Grants permission to call UC function
# - Required for UC_FUNCTION_* configuration
# - Syntax: {catalog}.{schema}.{function_name}

# Quality Monitor Permission (CAN_VIEW):
# - Used for vector search indexes
# - Grants read access to vector index
# - Syntax: {catalog}.{schema}.{index_name}

# Quality Monitor Permission (CAN_EDIT):
# - Used for Genie spaces
# - Grants query access to Genie space
# - Syntax: genie.space.{space_id}

# ============================================
# Discovering Resource Names
# ============================================

# List Genie Spaces:
#   databricks api /api/2.0/genie/spaces/list

# List Vector Search Indexes:
#   databricks api /api/2.0/vector-search/indexes/list

# List UC Functions in a schema:
#   databricks api /api/2.0/unity-catalog/functions/list?catalog_name=main&schema_name=default

# List UC Tables in a schema:
#   databricks api /api/2.0/unity-catalog/tables/list?catalog_name=main&schema_name=default

# List UC Schemas in a catalog:
#   databricks api /api/2.0/unity-catalog/schemas/list?catalog_name=main
